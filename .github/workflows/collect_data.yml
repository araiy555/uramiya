
# ========================================
# GitHub Actions: ä¼æ¥­ãƒ‡ãƒ¼ã‚¿è‡ªå‹•åé›†
# ========================================
# 
# ãƒ•ã‚¡ã‚¤ãƒ«å: .github/workflows/collect-data.yml
#

name: ä¼æ¥­ãƒ‡ãƒ¼ã‚¿è‡ªå‹•åé›†

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  # æ¯æ—¥0æ™‚ï¼ˆJST 9æ™‚ï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * *'  # UTCæ™‚åˆ»
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      prefecture_code:
        description: 'éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ (01-47, allã§å…¨å›½)'
        required: false
        default: '13'
      max_pages:
        description: 'åé›†ãƒšãƒ¼ã‚¸æ•° (1ãƒšãƒ¼ã‚¸=100ç¤¾)'
        required: false
        default: '1'
      delay:
        description: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰'
        required: false
        default: '2000'

# ç’°å¢ƒå¤‰æ•°
env:
  NODE_VERSION: '20'

jobs:
  # ========================================
  # ã‚¸ãƒ§ãƒ–1: ãƒ‡ãƒ¼ã‚¿åé›†
  # ========================================
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“¦ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      # Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      # ãƒ‡ãƒ¼ã‚¿åé›†å®Ÿè¡Œ
      - name: ğŸš€ ãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹
        env:
          NTA_APP_ID: ${{ secrets.NTA_APP_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          node scripts/collect-github-action.js \
            --prefecture="${{ github.event.inputs.prefecture_code || '13' }}" \
            --pages="${{ github.event.inputs.max_pages || '1' }}" \
            --delay="${{ github.event.inputs.delay || '2000' }}"
      
      # çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“Š åé›†çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: collection-results
          path: logs/collection-*.json
          retention-days: 30
      
      # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ğŸ“¢ Slacké€šçŸ¥
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†: ${{ job.status }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ========================================
  # ã‚¸ãƒ§ãƒ–2: çµ±è¨ˆæƒ…å ±æ›´æ–°ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  # ========================================
  update-stats:
    runs-on: ubuntu-latest
    needs: collect-data
    
    steps:
      - name: ğŸ“¦ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ğŸ“ˆ çµ±è¨ˆæƒ…å ±æ›´æ–°
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: node scripts/update-stats.js

# ========================================
# è¤‡æ•°éƒ½é“åºœçœŒã‚’ä¸¦åˆ—åé›†
# ========================================
  collect-multiple:
    # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.prefecture_code == 'all'
    
    runs-on: ubuntu-latest
    
    strategy:
      # ä¸¦åˆ—å®Ÿè¡Œæ•°ï¼ˆGitHub Actionsã®åˆ¶é™: 20ä¸¦åˆ—ï¼‰
      max-parallel: 10
      
      # å¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶šè¡Œ
      fail-fast: false
      
      # éƒ½é“åºœçœŒãƒªã‚¹ãƒˆ
      matrix:
        prefecture: [
          '01', '02', '03', '04', '05', '06', '07', '08', '09', '10',
          '11', '12', '13', '14', '15', '16', '17', '18', '19', '20',
          '21', '22', '23', '24', '25', '26', '27', '28', '29', '30',
          '31', '32', '33', '34', '35', '36', '37', '38', '39', '40',
          '41', '42', '43', '44', '45', '46', '47'
        ]
    
    steps:
      - name: ğŸ“¦ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ğŸš€ éƒ½é“åºœçœŒ ${{ matrix.prefecture }} ã‚’åé›†
        env:
          NTA_APP_ID: ${{ secrets.NTA_APP_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          node scripts/collect-github-action.js \
            --prefecture="${{ matrix.prefecture }}" \
            --pages="5" \
            --delay="1500"
      
      - name: ğŸ“Š çµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: collection-results-${{ matrix.prefecture }}
          path: logs/collection-*.json
          retention-days: 30
