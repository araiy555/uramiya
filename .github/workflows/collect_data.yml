
# ========================================
# GitHub Actions: 企業データ自動収集
# ========================================
# 
# ファイル名: .github/workflows/collect-data.yml
#

name: 企業データ自動収集

# トリガー設定
on:
  # 毎日0時（JST 9時）に実行
  schedule:
    - cron: '0 0 * * *'  # UTC時刻
  
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      prefecture_code:
        description: '都道府県コード (01-47, allで全国)'
        required: false
        default: '13'
      max_pages:
        description: '収集ページ数 (1ページ=100社)'
        required: false
        default: '1'
      delay:
        description: 'リクエスト間隔（ミリ秒）'
        required: false
        default: '2000'

# 環境変数
env:
  NODE_VERSION: '20'

jobs:
  # ========================================
  # ジョブ1: データ収集
  # ========================================
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
      # リポジトリをチェックアウト
      - name: 📦 チェックアウト
        uses: actions/checkout@v4
      
      # Node.jsセットアップ
      - name: 🔧 Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # 依存関係をインストール
      - name: 📥 依存関係インストール
        run: npm ci
      
      # データ収集実行
      - name: 🚀 データ収集開始
        env:
          NTA_APP_ID: ${{ secrets.NTA_APP_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          node scripts/collect-github-action.js \
            --prefecture="${{ github.event.inputs.prefecture_code || '13' }}" \
            --pages="${{ github.event.inputs.max_pages || '1' }}" \
            --delay="${{ github.event.inputs.delay || '2000' }}"
      
      # 結果をアップロード
      - name: 📊 収集結果をアップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: collection-results
          path: logs/collection-*.json
          retention-days: 30
      
      # Slack通知（オプション）
      - name: 📢 Slack通知
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "データ収集完了: ${{ job.status }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ========================================
  # ジョブ2: 統計情報更新（並列実行）
  # ========================================
  update-stats:
    runs-on: ubuntu-latest
    needs: collect-data
    
    steps:
      - name: 📦 チェックアウト
        uses: actions/checkout@v4
      
      - name: 🔧 Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: 📥 依存関係インストール
        run: npm ci
      
      - name: 📈 統計情報更新
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: node scripts/update-stats.js

# ========================================
# 複数都道府県を並列収集
# ========================================
  collect-multiple:
    # 手動実行時のみ
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.prefecture_code == 'all'
    
    runs-on: ubuntu-latest
    
    strategy:
      # 並列実行数（GitHub Actionsの制限: 20並列）
      max-parallel: 10
      
      # 失敗しても他を続行
      fail-fast: false
      
      # 都道府県リスト
      matrix:
        prefecture: [
          '01', '02', '03', '04', '05', '06', '07', '08', '09', '10',
          '11', '12', '13', '14', '15', '16', '17', '18', '19', '20',
          '21', '22', '23', '24', '25', '26', '27', '28', '29', '30',
          '31', '32', '33', '34', '35', '36', '37', '38', '39', '40',
          '41', '42', '43', '44', '45', '46', '47'
        ]
    
    steps:
      - name: 📦 チェックアウト
        uses: actions/checkout@v4
      
      - name: 🔧 Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: 📥 依存関係インストール
        run: npm ci
      
      - name: 🚀 都道府県 ${{ matrix.prefecture }} を収集
        env:
          NTA_APP_ID: ${{ secrets.NTA_APP_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          node scripts/collect-github-action.js \
            --prefecture="${{ matrix.prefecture }}" \
            --pages="5" \
            --delay="1500"
      
      - name: 📊 結果をアップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: collection-results-${{ matrix.prefecture }}
          path: logs/collection-*.json
          retention-days: 30
